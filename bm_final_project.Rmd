---
title: "bm_final_project"
author: "Yun He"
date: "December 6, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(glmnet)
library(HH)

library(faraway)
library(leaps)
library(caret)
library(boot)
library(broom)

```

```{r}
cancer = read_csv("./Cancer_Registry.csv")
colSums(is.na(cancer)) # 'PctSomeCol18_24', 'PctEmployed16_Over','PctPrivateCoverageAlone' should be removed because they have lots of NA.  
```

```{r}
cancer = read_csv("./Cancer_Registry.csv") %>% 
  select(-PctSomeCol18_24, -PctEmployed16_Over, -PctPrivateCoverageAlone) %>% 
  # set the cutoff for low and high income as 47k
  mutate(medIncome = as.numeric(medIncome)) %>% 
  mutate(income_cutoff = ifelse(medIncome >= mean(cancer$medIncome),1,0)) %>%
  # set the cutoff for age at mean median age 
  mutate(age_cutoff = ifelse(MedianAge >= mean(cancer$MedianAge),1,0)) %>%
  separate(Geography, into = c("County", "State"), sep = ",") %>%
  # remove unnecessary columns 'binnedInc'sicne we have already set the cutoff for income and 'PctNoHS18_24' should be removed because there is no corresponding variable for people who are 25 and over.
  select(-binnedInc, -PctNoHS18_24) %>% 
  # make dependent variable at 1st column 
  select(TARGET_deathRate, everything())
  # see the correlation
cancer_cor = cancer %>% 
  select(-State, -County)
cor(cancer_cor) %>% knitr::kable()
  # get descriptive information of cancer 
attach(cancer)
summary(cancer)
```

```{r}
 # make multilinear regression model to see which variables are significant 
multi.fit <- lm(TARGET_deathRate ~ ., data = cancer_cor)
summary(multi.fit)
```

```{r}
  # select 10 variables that we choosen after compare with the information from the research literature 
cancer_model = cancer %>% 
  select(TARGET_deathRate, avgAnnCount, incidenceRate, AvgHouseholdSize, studyPerCap, income_cutoff, age_cutoff, PercentMarried, PctPrivateCoverage, PctWhite, PctHS25_Over)  
 # make histogram to see the distribution of the variables and decide whether we need transformation 
cancer_model %>%
  select(-income_cutoff, -age_cutoff) %>%
  gather(measure, value) %>%
  ggplot(aes(value)) +
  facet_wrap(. ~ measure, scales = "free") +
  geom_histogram()
 # all the correlation value are below 0.7, so there is no covariances. 
 cor(cancer_model) %>% knitr::kable()
```

## Data cleaning 

```{r}
cancer = read_csv("./Cancer_Registry.csv") %>% 
  janitor::clean_names() %>% 
  separate(geography, into = c("county", "state"), sep = ",")

## demographic: age, race, marital status, income, education, employment and health insurance coverage
income_employ_insur = cancer %>% 
  dplyr::select(med_income, pct_employed16_over, pct_unemployed16_over, pct_private_coverage, pct_private_coverage_alone, pct_emp_priv_coverage, pct_public_coverage, pct_public_coverage_alone)
cor(income_employ_insur)
## income and health insurance coverage are highly correlated

income_edu = cancer %>% 
  dplyr::select(med_income, pct_no_hs18_24, pct_hs18_24, pct_bach_deg18_24, pct_hs25_over, pct_bach_deg25_over)
cor(income_edu) 
## high correlation between med_income and pct_bach_deg25_over, pct_hs25_over and pct_bach_deg25_over, so choose pct_hs25_over

race = cancer %>% 
  dplyr::select(pct_white, pct_black, pct_asian, pct_other_race)
cor(race)
## white and black are highly correlated

## Check with missing values
skimr::skim(cancer %>% select(-state, -county))

## Select variables
cancer = cancer %>% 
  dplyr::select(state, county, target_death_rate, incidence_rate, study_per_cap, binned_inc, median_age, percent_married, pct_no_hs18_24, pct_hs18_24, pct_bach_deg18_24, pct_hs25_over, pct_white, pct_asian, pct_other_race) %>% 
  mutate(binned_inc = factor(binned_inc),
         binned_inc = relevel(binned_inc, ref = "[22640, 34218.1]"),
         age_cat = ifelse(median_age > 20 & median_age <= 39, 0, 1)) %>% 
  dplyr::select(-median_age)

cancer = cancer %>% 
  dplyr::select(state, county, target_death_rate, incidence_rate, study_per_cap, binned_inc, median_age, percent_married, pct_no_hs18_24, pct_hs18_24, pct_bach_deg18_24, pct_hs25_over, pct_white, pct_asian, pct_other_race) %>% 
  mutate(binned_inc = factor(binned_inc),
         binned_inc = relevel(binned_inc, ref = "[22640, 34218.1]"))
## do we have to categorize age?
```

The original dataset has 35 variables and 3047 observations. 

After exploring the dataset, we found that variables 'pct_employed16_over', 'pct_private_coverage_alone' and 'pct_some_col18_24' had missing values. Variables 'pct_private_coverage_alone' and 'pct_some_col18_24' has to be removed for subsequent analyses because of the relatively large amount of missing values. 

Both employment status and health insurance coverage status can be reflected by income. Thus, we only included income for subsequent analyses. We chose the variable 'binned_inc' from 'med_income', 'poverty_percent' and 'binned_inc' for measuring the income level. We chose 'percent_married' from 'percent_married' and 'pct_married_households' for measuring the marital status. We chose 'median_age' from 'median_age', 'median_age_female' and 'median_age_male' for measuring the age. 'pct_white' and 'pct_black' are highly correlated, thus, we removed 'pct_black'. 'pct_hs25_over' and 'pct_bach_deg25_over' re highly correlated, thus, we removed 'pct_bach_deg25_over'. Finally, we included demographic variables for age, income, race, education and marital status for subsequent analyses which, in previous research, are also found to be correlated with cancer mortality. 

We also chose 'incidence_rate' from 'avg_ann_count' and 'incidence_rate' for measuring mean cancer diagnoses annually. 

In addition, because our outcome is 'target_death_rate' which can be calculated from dividing the variable 'avg_deaths_per_year' by the variable 'pop_est2015', we removed these two variables from our dataset. 'avg_household_size' and 'birth_rate' seem to be uncorrelated with the outcome, thus, we removed them from our dataset as well. 

We ended with the dataset of 15 variables and 3047 observations.

Marital status is also correlated with cancer mortality. 
https://www.ncbi.nlm.nih.gov/pubmed/29727804

## Data exploration

```{r}
## Distribution of continuous variables
descp_stats = function(x){
  df = broom::tidy(summary(x)) %>% 
    mutate(sd = sd(x))
  return(df)
}

cancer %>% 
  dplyr::select(-state, -county, -binned_inc, -age_cat) %>% 
  map_df(descp_stats) %>%
  mutate(variable = c("target_death_rate", "incidence_rate", "study_per_cap", "percent_married", "pct_no_hs18_24", "pct_hs18_24", "pct_bach_deg18_24", "pct_hs25_over", "pct_white", "pct_asian", "pct_other_race")) %>% 
  dplyr::select(variable, mean, sd, everything()) %>%
  knitr::kable(digits = 2)

## Distribution of the death rate
cancer %>%
  ggplot(aes(x = target_death_rate)) + 
  geom_histogram(aes(y = ..density..)) + geom_density(color = "red")

## Distribution of categorical variables
cancer %>% 
  ggplot(aes(x = binned_inc, y = target_death_rate)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

cancer %>% 
  ggplot(aes(x = factor(age_cat), y = target_death_rate)) + geom_boxplot()
```

The outcome 'death rate' is normally distributed.

## Fit the model

```{r}
cancer_mod = cancer %>% 
  dplyr::select(-state, -county)

fit = lm(target_death_rate ~ ., data = cancer_mod)
summary(fit)

step(fit, direction = "backward")
refit = lm(target_death_rate ~ incidence_rate + binned_inc + 
    percent_married + pct_hs18_24 + pct_bach_deg18_24 + pct_hs25_over + 
    pct_white + pct_other_race + age_cat, data = cancer_mod)
vif(refit)

```

## Lasso regression

```{r}
cancer = cancer %>% 
  dplyr::select(state, county, target_death_rate, incidence_rate, study_per_cap, med_income, median_age, percent_married, pct_no_hs18_24, pct_hs18_24, pct_bach_deg18_24, pct_hs25_over, pct_white, pct_asian, pct_other_race) %>% 
  mutate(age_cat = ifelse(median_age > 20 & median_age <= 39, 0, 1)) %>% 
  dplyr::select(-median_age)

cancer_mod = cancer %>% 
  dplyr::select(-state, -county)

## no NA
Y <- as.matrix(cancer_mod[,1])
X <- as.matrix(cancer_mod[,-1])
grid <- 10^seq(5,-2, length=100)
ridge3<-glmnet(X, Y, alpha=1, lambda=grid)

set.seed(2)
cv.out<-cv.glmnet(X,Y)
plot(cv.out)
best.lambda<-cv.out$lambda.min
lasso2<-glmnet(X, Y, alpha =1, lambda=best.lambda)
coef(lasso2)
```

