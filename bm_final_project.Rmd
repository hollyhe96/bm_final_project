---
title: "bm_final_project"
author: "Yun He"
date: "December 6, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(faraway)
library(leaps)
library(caret)
library(boot)
library(broom)
library(glmnet)
```

```{r}
cancer = read_csv("./Cancer_Registry.csv")
colSums(is.na(cancer)) # 'PctSomeCol18_24', 'PctEmployed16_Over','PctPrivateCoverageAlone' should be removed because they have lots of NA.  
```

```{r}
cancer = read_csv("./Cancer_Registry.csv") %>% 
  select(-PctSomeCol18_24, -PctEmployed16_Over, -PctPrivateCoverageAlone) %>% 
  # set the cutoff for low and high income as 47k
  mutate(medIncome = as.numeric(medIncome)) %>% 
  mutate(income_cutoff = ifelse(medIncome >= mean(cancer$medIncome),1,0)) %>%
  # set the cutoff for age at mean median age 
  mutate(age_cutoff = ifelse(MedianAge >= mean(cancer$MedianAge),1,0)) %>%
  separate(Geography, into = c("County", "State"), sep = ",") %>%
  # remove unnecessary columns 'binnedInc'sicne we have already set the cutoff for income and 'PctNoHS18_24' should be removed because there is no corresponding variable for people who are 25 and over.
  select(-binnedInc, -PctNoHS18_24) %>% 
  # make dependent variable at 1st column 
  select(TARGET_deathRate, everything())
  # see the correlation
cancer_cor = cancer %>% 
  select(-State, -County)
cor(cancer_cor) %>% knitr::kable()
  # get descriptive information of cancer 
attach(cancer)
summary(cancer)
```

```{r}
 # make multilinear regression model to see which variables are significant 
multi.fit <- lm(TARGET_deathRate ~ ., data = cancer_cor)
summary(multi.fit)
```

```{r}
  # select 10 variables that we choosen after compare with the information from the research literature 
cancer_model = cancer %>% 
  select(TARGET_deathRate, avgAnnCount, incidenceRate, AvgHouseholdSize, studyPerCap, income_cutoff, age_cutoff, PercentMarried, PctPrivateCoverage, PctWhite, PctHS25_Over)  
 # make histogram to see the distribution of the variables and decide whether we need transformation 
cancer_model %>%
  select(-income_cutoff, -age_cutoff) %>%
  gather(measure, value) %>%
  ggplot(aes(value)) +
  facet_wrap(. ~ measure, scales = "free") +
  geom_histogram()
 # all the correlation value are below 0.7, so there is no covariances. 
 cor(cancer_model) %>% knitr::kable()
```

## Data cleaning and exploration

```{r}
cancer = read_csv("./Cancer_Registry.csv") %>% 
  janitor::clean_names() %>% 
  separate(geography, into = c("county", "state"), sep = ",")

skimr::skim(cancer %>% select(-state, -county))
cor(cancer$med_income, cancer$poverty_percent)
cor(cancer$percent_married, cancer$pct_married_households)

cancer %>% 
  ggplot(aes(x = poverty_percent, y = target_death_rate)) + geom_point()

cancer = cancer %>% 
  select(-avg_ann_count, -avg_deaths_per_year, -pop_est2015, -med_income, -poverty_percent, -median_age_male, -median_age_female, -avg_household_size, -pct_some_col18_24, -pct_private_coverage_alone, -birth_rate, -pct_married_households) %>% 
  select(state, county, target_death_rate, everything()) %>% 
  mutate(binned_inc = factor(binned_inc),
         binned_inc = relevel(binned_inc, ref = "[22640, 34218.1]"),
         ct_status = ifelse(study_per_cap == 0, 0, 1),
         age_cat = ifelse(median_age > 20 & median_age <= 39, 0, 1)) %>% 
  select(-study_per_cap, -median_age)

## distribution of death rate
cancer %>%
  ggplot(aes(x = target_death_rate)) + 
  geom_histogram(aes(y = ..density..)) + geom_density(color = "red")

cancer %>% 
  ggplot(aes(x = binned_inc, y = target_death_rate)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

cancer %>% 
  ggplot(aes(x = factor(ct_status), y = target_death_rate)) + geom_boxplot()

cancer %>% 
  ggplot(aes(x = factor(income_status), y = target_death_rate)) + geom_boxplot()


```

## Fit the model

```{r}
cancer_mod = cancer %>% 
  select(-state, -county)
fit = lm(target_death_rate ~ ., data = cancer_mod)
summary(fit)

step(fit, direction = "backward")


## Lasso regression
Y <- as.matrix(cancer_mod[,1])
X <- as.matrix(cancer_mod[,-1])
grid <- 10^seq(5,-2, length=100)
ridge3<-glmnet(X, Y, alpha=1, lambda=grid)

set.seed(2)
cv.out<-cv.glmnet(X,Y)
plot(cv.out)
best.lambda<-cv.out$lambda.min
lasso2<-glmnet(X, Y, alpha =1, lambda=best.lambda)
coef(lasso2)

```

